<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>90é¡¹å¿ƒç†å¥åº·ç­›æŸ¥ä¸“ä¸šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://dl.ifanr666.com/sdk/sdk-web-latest.js"></script>
</head>
<body>
    <div id="app" class="container">
        <div id="welcome-screen">
            <div class="brand-tag">å¿ƒç†å®éªŒå®¤</div>
            <h1>90é¡¹å¿ƒç†å¥åº·ç­›æŸ¥</h1>
            <p class="subtitle"ä¸´åºŠå¸¸ç”¨ 90é¢˜æ ‡å‡†ç‰ˆ | è‡ªæˆ‘çŠ¶æ€æ·±åº¦ç”»åƒ</p>
            <div class="auth-box" style="margin-top: 40px;">
                <input type="text" id="token-input" placeholder="è¯·è¾“å…¥æµ‹è¯„ç ">
                <button class="main-btn" onclick="startQuiz()">å¼€å¯æµ‹è¯„</button>
            </div>
            <div id="resume-tip" style="display:none; margin-top:20px; color:#7BBAB1; font-size:13px; cursor:pointer;" onclick="resumeProgress()">
                æ£€æµ‹åˆ°ä¸Šæ¬¡æœªå®Œæˆè¿›åº¦ï¼Œç‚¹å‡»æ­¤å¤„ç»§ç»­ >
            </div>
        </div>

        <div id="quiz-screen" style="display:none;">
            <div class="progress-container"><div id="progress-bar"></div></div>
            <div class="q-header">
                <span id="q-count">01/90</span>
                <span class="restart-btn" onclick="restartQuiz()">æ”¾å¼ƒå¹¶é‡æ–°å¼€å§‹</span>
            </div>
            <div id="question-text" class="q-card">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
            <div class="options-group">
                <button class="opt-btn" onclick="handleAnswer(0)">ä»æ—  (0)</button>
                <button class="opt-btn" onclick="handleAnswer(1)">å¾ˆè½» (1)</button>
                <button class="opt-btn" onclick="handleAnswer(2)">ä¸­åº¦ (2)</button>
                <button class="opt-btn" onclick="handleAnswer(3)">åé‡ (3)</button>
                <button class="opt-btn" onclick="handleAnswer(4)">ä¸¥é‡ (4)</button>
            </div>
        </div>

        <div id="result-screen" style="display:none;">
            <div id="poster-area">
                <div class="poster-inner">
                    <div style="background:#fff3f3; padding:12px; border-left:4px solid #e74c3c; margin-bottom:20px; font-size:13px; color:#e74c3c;">
                        âš ï¸ æœ¬æŠ¥å‘Šä»…ä¸ºå¿ƒç†å¥åº·ç­›æŸ¥å‚è€ƒå·¥å…·ï¼Œç»“æœä¸ä½œä¸ºä»»ä½•åŒ»å­¦è¯Šæ–­ä¾æ®ã€‚å¦‚æœ‰å›°æ‰°è¯·å°½å¿«å¯»æ±‚ä¸“ä¸šå¸®åŠ©ã€‚
                    </div>
                    <div class="brand-tag">å¿ƒçµè¯„ä¼°æŠ¥å‘Š</div>
                    <h2 class="poster-title">90é¢˜å¿ƒç†èƒ½é‡ç”»åƒ</h2>

                    <div class="norm-comparison">
                        <div class="comparison-header">
                            <span>æ€»åˆ†å‹åŠ›æ°´å¹³å¯¹æ¯”</span>
                            <span id="score-tag" class="tag-normal">æ­£å¸¸</span>
                        </div>
                        <div class="meter-bar">
                            <div id="score-pointer" class="pointer"></div>
                            <div class="zone healthy"></div>
                            <div class="zone warning"></div>
                            <div class="zone danger"></div>
                        </div>
                        <div class="meter-labels" style="display:flex; justify-content:space-between; font-size:10px; color:#999; margin-top:5px;">
                            <span>0</span><span>160(å¸¸æ¨¡)</span><span>360</span>
                        </div>
                    </div>

                    <div class="score-grid" id="score-container"></div>
                    <div id="result-chart" style="width:100%; height:300px;"></div>

                    <div class="detail-list-section">
                        <h4 class="section-title">ğŸ“Œ å„ç»´åº¦å¾—åˆ†æ˜ç»†</h4>
                        <div id="factor-detail-list"></div>
                    </div>

                    <div class="prescription-card">
                        <div class="prescription-title">ğŸ’Š è‡ªæˆ‘è°ƒèŠ‚å‚è€ƒå»ºè®®</div>
                        <ul class="prescription-list" id="prescription-list"></ul>
                        <div class="prescription-footer">â€”â€” å¿ƒçµå®éªŒå®¤ Â· å»ºè®® â€”â€”</div>
                    </div>

                    <div class="disclaimer-box">
                        <p><strong>âš ï¸ é‡è¦å£°æ˜ï¼š</strong></p>
                        <p>1. æœ¬å·¥å…·ä»…ä¸ºè‡ªæˆ‘ç­›æŸ¥å‚è€ƒå·¥å…·ï¼Œä¸æ„æˆä»»ä½•åŒ»å­¦è¯Šæ–­æˆ–æ²»ç–—å»ºè®®ã€‚</p>
                        <p>2. ç»“æœä»…åæ˜ æ‚¨è¿‘ä¸€å‘¨çš„ä¸»è§‚æ„Ÿå—ï¼Œå—ä¸ªäººçŠ¶æ€ã€ç¯å¢ƒå½±å“å¯èƒ½æ³¢åŠ¨ã€‚</p>
                        <p>3. å¦‚æœ‰ä¸é€‚ï¼Œè¯·åŠæ—¶å’¨è¯¢ä¸“ä¸šå¿ƒç†å’¨è¯¢å¸ˆæˆ–ç²¾ç¥ç§‘åŒ»å¸ˆã€‚</p>
                        <p>4. æˆ‘ä»¬ä¸¥æ ¼éµå®ˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ï¼Œæ‰€æœ‰æ•°æ®åŠ å¯†å­˜å‚¨ï¼Œä»…ç”¨äºç”ŸæˆæŠ¥å‘Šã€‚</p>
                        <p>5. æœªç»æ‚¨æ˜ç¡®åŒæ„ï¼Œç»ä¸ç”¨äºä»»ä½•å•†ä¸šç”¨é€”æˆ–ç¬¬ä¸‰æ–¹åˆ†äº«ã€‚</p>
                    </div>

                    <div class="poster-footer">
                        <p>æŠ¥å‘Šç¼–å·ï¼š<span id="report-id">--</span></p>
                        <p>æµ‹è¯„æ—¶é—´ï¼š<span id="report-date">--</span></p>
                    </div>
                </div>
            </div>
            <div style="padding: 20px;">
                <button class="main-btn" onclick="savePoster()">ä¿å­˜é«˜æ¸…æŠ¥å‘Šæµ·æŠ¥</button>
                <button class="main-btn secondary" onclick="location.reload()">é‡æ–°æµ‹è¯„</button>
            </div>
        </div>
    </div>

    <script src="questions.js"></script>
    <script>

    let currentIdx = 0;
    let answers = [];
    let activeToken = "";

    // 1. åˆå§‹åŒ–ä¸è‡ªåŠ¨æ ¡éªŒ
    window.onload = async () => {
        // ã€å¿…é¡»ä¿®æ”¹ã€‘æ›¿æ¢ä¸ºæ‚¨çš„çœŸå® ClientID
        BaaS.init('c59dcfb2384b4bc95ff0'); 

        const urlParams = new URLSearchParams(window.location.search);
        const tokenFromUrl = urlParams.get('token');

        if (tokenFromUrl) {
            document.getElementById('token-input').value = tokenFromUrl;
            verifyAndStart(tokenFromUrl);
        }

        if(localStorage.getItem('scl90_progress')) {
            document.getElementById('resume-tip').style.display = 'block';
        }
    };

    // 2. æ ¸å¿ƒæ ¡éªŒé€»è¾‘
    async function verifyAndStart(tk) {
        const startBtn = document.querySelector('.main-btn');
        const originalText = startBtn.innerText;
        startBtn.innerText = "æ ¡éªŒä¸­...";
        startBtn.disabled = true;

        try {
            // ã€å¿…é¡»ä¿®æ”¹ã€‘æ›¿æ¢ä¸ºæ‚¨çš„çœŸå®æ•°æ®è¡¨ IDï¼ˆæ•°å­—ï¼‰
            let MyTable = new BaaS.TableObject('698ac4cc11cd21804fa3c3c1'); 
            let query = new BaaS.Query();
            query.compare('token_string', '=', tk);
            query.compare('is_used', '=', false);

            let res = await MyTable.setQuery(query).find();

            if (res.data.objects && res.data.objects.length > 0) {
                activeToken = tk;
                setTimeout(() => { initQuiz(); }, 500);
            } else {
                alert("è¯¥æµ‹è¯„é“¾æ¥å·²å¤±æ•ˆæˆ–æµ‹è¯„ç é”™è¯¯");
                startBtn.innerText = originalText;
                startBtn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•");
            startBtn.disabled = false;
            startBtn.innerText = originalText;
        }
    }

    // ç»‘å®šç»™æŒ‰é’®çš„å‡½æ•°
    function startQuiz() {
        const tk = document.getElementById('token-input').value.trim();
        if(!tk) return alert("è¯·è¾“å…¥æµ‹è¯„ç ");
        
        if (!confirm("æœ¬æµ‹è¯„ä¼šæ”¶é›†æ‚¨çš„ä½œç­”æ•°æ®ç”¨äºç”ŸæˆæŠ¥å‘Šã€‚æ˜¯å¦åŒæ„ï¼Ÿ")) return;
        verifyAndStart(tk);
    }

    // 3. ç»“æœæ¸²æŸ“ä¸è‡ªåŠ¨æ ¸é”€
    async function renderResult() {
        // --- æ ¸å¿ƒæ ¸é”€é€»è¾‘ï¼šæ”¾åœ¨å‡½æ•°æœ€å¼€å§‹ ---
        if (activeToken) {
            try {
                let MyTable = new BaaS.TableObject('æ‚¨çš„æ•°æ®è¡¨ID'); 
                let query = new BaaS.Query();
                query.compare('token_string', '=', activeToken);
                let res = await MyTable.setQuery(query).find();
                
                if (res.data.objects && res.data.objects.length > 0) {
                    let recordId = res.data.objects[0]._id;
                    let record = MyTable.getWithoutData(recordId);
                    record.set('is_used', true); 
                    await record.update();
                    console.log("Tokenå·²æˆåŠŸæ ¸é”€");
                }
            } catch (e) {
                console.warn("Tokenæ ¸é”€å¤±è´¥:", e);
            }
        }

        // æ¸…é™¤è¿›åº¦å¹¶åˆ‡æ¢å±å¹•
        localStorage.removeItem('scl90_progress');
        document.getElementById('quiz-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';

        // ... è®¡ç®—æ€»åˆ† ...
        const totalScore = answers.reduce((sum, a) => sum + (a.score || 0), 0);
        const totalAvg = (totalScore / 90).toFixed(2);
        const positiveItems = answers.filter(a => a.score >= 1).length;
        const psdi = positiveItems > 0 ? (totalScore / positiveItems).toFixed(2) : 0;

        // ... æ›´æ–°UIä¸åˆ»åº¦å°º (ä¿æŒæ‚¨åŸæœ‰çš„ä»£ç å³å¯) ...
        updateUI(totalScore, totalAvg, positiveItems, psdi);
    }

        function resumeProgress() {
            const saved = JSON.parse(localStorage.getItem('scl90_progress'));
            if(saved) { 
                activeToken = saved.token; 
                answers = saved.answers || []; 
                currentIdx = saved.currentIdx || 0; 
                initQuiz(); 
            }
        }

        function initQuiz() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'block';
            showQuestion();
        }

        function showQuestion() {
            if (typeof questions === 'undefined') return alert("é¢˜ç›®æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ questions.js");
            const q = questions[currentIdx];
            document.getElementById('question-text').innerText = q.q;
            document.getElementById('q-count').innerText = `${String(currentIdx+1).padStart(2,'0')}/90`;
            document.getElementById('progress-bar').style.width = ((currentIdx+1)/90*100) + '%';
        }

        function handleAnswer(score) {
            answers[currentIdx] = { id: questions[currentIdx].id, score: score, dim: questions[currentIdx].dim };
            localStorage.setItem('scl90_progress', JSON.stringify({ 
                token: activeToken, 
                answers: answers, 
                currentIdx: currentIdx + 1 
            }));
            
            if(currentIdx < 89) { 
                currentIdx++; 
                showQuestion(); 
            } else { 
                renderResult(); 
            }
        }

        // 1. æ³¨æ„è¿™é‡ŒåŠ äº† async
        async function renderResult() {
            // --- æ–°å¢ï¼šæ ¸é”€ Token ç¡®ä¿å•æ¬¡æœ‰æ•ˆ ---
            if (activeToken) {
                try {
                    // è¯·ç¡®ä¿è¿™é‡Œçš„æ•°å­— ID ä¸ window.onload é‡Œçš„ä¿æŒä¸€è‡´
                    let MyTable = new BaaS.TableObject('ä½ çš„æ•°æ®è¡¨ID'); 
                    let query = new BaaS.Query();
                    query.compare('token_string', '=', activeToken);
                    let res = await MyTable.setQuery(query).find();
                    
                    if (res.data.objects && res.data.objects.length > 0) {
                        let recordId = res.data.objects[0]._id;
                        let record = MyTable.getWithoutData(recordId);
                        record.set('is_used', true); // æ ¸å¿ƒï¼šæ ‡è®°ä¸ºå·²ä½¿ç”¨
                        await record.update();
                        console.log("Token å·²æ ¸é”€");
                    }
                } catch (e) {
                    console.warn("Token æ ¸é”€å¤±è´¥ï¼Œä½†ä¸å½±å“ç»“æœå±•ç¤º:", e);
                }
            }

        function renderResult() {
            localStorage.removeItem('scl90_progress');
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';

            const totalScore = answers.reduce((sum, a) => sum + (a.score || 0), 0);
            const totalAvg = (totalScore / 90).toFixed(2);
            const positiveItems = answers.filter(a => a.score >= 1).length;
            const psdi = positiveItems > 0 ? (totalScore / positiveItems).toFixed(2) : 0;

            // æ›´æ–°åˆ»åº¦å°º
            const pointerPos = Math.min((totalScore / 360) * 100, 100);
            document.getElementById('score-pointer').style.left = pointerPos + '%';
            const scoreTag = document.getElementById('score-tag');
            scoreTag.innerText = totalScore > 160 ? "é˜³æ€§é¢„è­¦" : "å¥åº·çŠ¶æ€";
            scoreTag.className = totalScore > 160 ? "tag-danger" : "tag-normal";

            let factorListHtml = "";
            let maxDim = "ç„¦è™‘"; 
            let topScore = -1;
            const radarData = [];
            const radarIndicators = [];
            const dimNames = ["èº¯ä½“åŒ–", "å¼ºè¿«ç—‡çŠ¶", "äººé™…æ•æ„Ÿ", "æŠ‘éƒ", "ç„¦è™‘", "æ•Œå¯¹", "ææ€–", "åæ‰§", "ç²¾ç¥ç—…æ€§"];
            
            dimNames.forEach(dim => {
                const dimAns = answers.filter(a => a.dim === dim);
                const factorScore = dimAns.length > 0 ? (dimAns.reduce((s, a) => s + a.score, 0) / dimAns.length).toFixed(2) : "0.00";
                radarData.push(factorScore);
                radarIndicators.push({ name: dim, max: 4 });

                if(parseFloat(factorScore) > topScore) {
                    topScore = parseFloat(factorScore);
                    maxDim = dim;
                }

                let statusClass = factorScore < 2 ? "status-low" : (factorScore < 3 ? "status-mid" : "status-high");
                let statusText = factorScore < 2 ? "æ­£å¸¸" : (factorScore < 3 ? "è½»åº¦" : "æ˜¾è‘—");

                factorListHtml += `
                    <div class="factor-row">
                        <div class="factor-info"><span class="factor-name">${dim}</span><span class="factor-value">${factorScore}</span></div>
                        <div class="factor-progress-bg"><div class="factor-progress-fill ${statusClass}" style="width: ${factorScore/4*100}%"></div></div>
                        <span class="factor-status-text ${statusClass}">${statusText}</span>
                    </div>`;
            });

            // å¡«å……å»ºè®®åˆ—è¡¨
            const pList = document.getElementById('prescription-list');
            if(pList && typeof prescriptionLib !== 'undefined') {
                const advices = prescriptionLib[maxDim] || ["ä¿æŒè§„å¾‹ä½œæ¯", "ä¿æŒå¿ƒæ€å¹³å’Œ"];
                pList.innerHTML = advices.map(text => `<li>${text}</li>`).join('');
            }

            document.getElementById('score-container').innerHTML = `
                <div class="score-item"><span>æ€»å¾—åˆ†</span><strong>${totalScore}</strong></div>
                <div class="score-item"><span>å‡åˆ†</span><strong>${totalAvg}</strong></div>
                <div class="score-item"><span>é˜³æ€§é¡¹æ•°</span><strong>${positiveItems}</strong></div>
                <div class="score-item"><span>ç—›è‹¦æŒ‡æ•°</span><strong>${psdi}</strong></div>`;

            document.getElementById('factor-detail-list').innerHTML = factorListHtml;
            initChart(radarIndicators, radarData);
        }

        function initChart(indicators, data) {
            const chart = echarts.init(document.getElementById('result-chart'));
            chart.setOption({
                animation: false, // å¿…é¡»å…³é—­åŠ¨ç”»ï¼Œå¦åˆ™æˆªå›¾æ—¶å¯èƒ½åªæœ‰åº•å›¾æ²¡æœ‰æ•°æ®çº¿
                radar: { 
                    indicator: indicators, 
                    shape: 'polygon', 
                    splitNumber: 4, 
                    axisName: { color: '#7BBAB1', fontSize: 10 } 
                },
                series: [{ 
                    type: 'radar', 
                    data: [{ 
                        value: data, 
                        areaStyle: { color: 'rgba(123, 186, 177, 0.4)' }, 
                        lineStyle: { color: '#7BBAB1', width: 2 } 
                    }] 
                }]
            });
        }

        function savePoster() {
            const posterArea = document.querySelector("#poster-area");
            if (!posterArea) {
                alert("æŠ¥å‘ŠåŒºåŸŸæœªåŠ è½½ï¼Œè¯·å…ˆå®Œæˆæµ‹è¯„");
                return;
            }

            // æ­£ç¡®é€‰æ‹©ä¿å­˜æŒ‰é’®
            const saveBtn = document.querySelector('button[onclick="savePoster()"]');
            if (!saveBtn) {
                alert("æ“ä½œå¼‚å¸¸ï¼Œè¯·åˆ·æ–°é‡è¯•");
                return;
            }

            const originalText = saveBtn.innerText;
            saveBtn.innerText = "æ­£åœ¨ä¼˜åŒ–ç”Ÿæˆ...";
            saveBtn.disabled = true;

            try {
                // å®‰å…¨è®¾ç½®ç¼–å·å’Œæ—¥æœŸ
                const reportIdEl = document.getElementById('report-id');
                if (reportIdEl) reportIdEl.innerText = 'PSY-' + Math.random().toString(36).substr(2, 6).toUpperCase();

                const reportDateEl = document.getElementById('report-date');
                if (reportDateEl) {
                    reportDateEl.innerText = new Date().toLocaleDateString('zh-CN', {
                        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                }

                // åŠ¨æ€ scaleï¼šç§»åŠ¨ç«¯é™ä½åˆ°2~2.5ï¼Œé¿å…æ¨¡ç³Š+ä½“ç§¯çˆ†ç‚¸
                const isMobile = window.innerWidth <= 768;
                const scale = isMobile ? 2.5 : 3;

                const options = {
                    scale: scale,
                    useCORS: true,
                    backgroundColor: "#FFFFFF",
                    logging: false,
                    allowTaint: true,
                    windowWidth: posterArea.scrollWidth,
                    windowHeight: posterArea.scrollHeight,
                    // å…³é”®ï¼šæå‡å›¾åƒå¹³æ»‘åº¦
                    imageTimeout: 15000,
                    removeContainer: true
                };

                html2canvas(posterArea, options).then(canvas => {
                    // é™åˆ¶æœ€å¤§å®½åº¦ï¼ˆé˜²æ­¢è¶…å¤§å›¾ï¼‰
                    let finalCanvas = canvas;
                    if (canvas.width > 1200) {
                        const ratio = 1200 / canvas.width;
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = 1200;
                        tempCanvas.height = canvas.height * ratio;
                        const ctx = tempCanvas.getContext('2d');
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                        finalCanvas = tempCanvas;
                    }

                    // è½¬ JPEG + è´¨é‡å‹ç¼©ï¼ˆä½“ç§¯å¤§å¹…å‡å°ï¼Œæ¸…æ™°åº¦æŸå¤±æå°ï¼‰
                    const imgData = finalCanvas.toDataURL('image/jpeg', 0.85);  // 0.85 æ˜¯å¹³è¡¡ç‚¹ï¼Œ0.7~0.9 éƒ½å¯è°ƒ

                    // åˆ›å»ºé¢„è§ˆå±‚
                    const overlay = document.createElement('div');
                    overlay.className = 'poster-overlay';
                    overlay.innerHTML = `
                        <img src="${imgData}" alt="æŠ¥å‘Šæµ·æŠ¥" style="max-width:90%; max-height:80vh; object-fit:contain;">
                        <div class="tips">â†‘ é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œï¼ˆå·²ä¼˜åŒ–ä½“ç§¯ï¼Œæ›´æ¸…æ™°ï¼‰ â†‘</div>
                        <button onclick="this.parentElement.remove()" style="margin-top:20px; background:none; border:1px solid rgba(255,255,255,0.5); color:#fff; padding:10px 30px; border-radius:30px; font-size:16px;">å…³é—­</button>
                    `;
                    document.body.appendChild(overlay);

                    // æ¢å¤æŒ‰é’®
                    saveBtn.innerText = originalText;
                    saveBtn.disabled = false;
                }).catch(err => {
                    console.error("ç”Ÿæˆå¤±è´¥:", err);
                    alert("ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·å°è¯•ç›´æ¥æˆªå±ä¿å­˜");
                    saveBtn.innerText = originalText;
                    saveBtn.disabled = false;
                });
            } catch (err) {
                console.error("savePoster å¼‚å¸¸:", err);
                alert("æ“ä½œå‡ºé”™ï¼Œè¯·åˆ·æ–°é‡è¯•");
                saveBtn.innerText = originalText;
                saveBtn.disabled = false;
            }
        }

        function clearProgress() { localStorage.removeItem('scl90_progress'); answers = []; currentIdx = 0; }
        function restartQuiz() { if(confirm("ç¡®å®šé‡æ–°å¼€å§‹å—ï¼Ÿ")) { clearProgress(); location.reload(); } }
    </script>
</body>
</html>